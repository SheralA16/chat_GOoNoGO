<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GO O NO GO - Chat en Tiempo Real | Historial Persistente</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #198754 0%, #20c997 100%);
            min-height: 100vh;
        }

        .chat-header {
            background: linear-gradient(45deg, #198754, #20c997);
        }

        .message-own {
            background: linear-gradient(45deg, #198754, #20c997);
        }

        .user-status.online {
            background: linear-gradient(45deg, #198754, #20c997);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 8px rgba(25, 135, 84, 0.6);
            }

            50% {
                box-shadow: 0 0 15px rgba(25, 135, 84, 0.8);
            }

            100% {
                box-shadow: 0 0 8px rgba(25, 135, 84, 0.6);
            }
        }

        .user-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-status.offline {
            background: #6c757d;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .chat-container {
            height: 85vh;
            max-height: 800px;
        }

        .messages-container {
            height: 400px;
            overflow-y: auto;
        }

        .users-list {
            height: 300px;
            overflow-y: auto;
        }

        .footer-brand {
            background: linear-gradient(45deg, #198754, #20c997);
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .message-image {
            max-width: 300px;
            max-height: 200px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .image-modal .modal-dialog {
            max-width: 90vw;
            max-height: 90vh;
        }

        .image-modal .modal-content {
            background: transparent;
            border: none;
        }

        .image-modal .modal-body {
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .file-input-container {
            position: relative;
            display: inline-block;
        }

        .file-input-hidden {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* ‚≠ê NUEVOS ESTILOS PARA HISTORIAL */
        .history-notification {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            border: none;
            animation: fadeInDown 0.5s ease-out;
        }

        .history-message {
            opacity: 0.85;
            border-left: 4px solid #6f42c1;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                content: '';
            }

            25% {
                content: '.';
            }

            50% {
                content: '..';
            }

            75% {
                content: '...';
            }

            100% {
                content: '';
            }
        }
    </style>
</head>

<body class="gradient-bg">
    <div class="container-fluid py-3">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-11">
                <div class="card shadow-lg border-0 chat-container">
                    <div class="row g-0 h-100">
                        <!-- Chat Principal -->
                        <div class="col-lg-8 d-flex flex-column">
                            <!-- Header del Chat -->
                            <div class="card-header chat-header text-white p-3">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h3 class="mb-1">
                                            <i class="bi bi-rocket-takeoff"></i> GO O NO GO
                                        </h3>
                                        <div class="small" id="connectionStatus">
                                            <i class="bi bi-circle-fill text-danger"></i> Desconectado
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-light text-dark px-3 py-2" id="onlineCount">
                                            <i class="bi bi-people-fill"></i> 0 conectados
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Estado de Conexi√≥n -->
                            <div class="alert alert-info mb-0 text-center border-0" id="connectionDetails">
                                <i class="bi bi-info-circle"></i> Listo para conectar...
                            </div>

                            <!-- Contenedor de Mensajes -->
                            <div class="flex-grow-1 p-3 messages-container" id="messages">
                                <div class="text-center text-muted">
                                    <i class="bi bi-chat-dots fs-1"></i>
                                    <p>No hay mensajes a√∫n. ¬°S√© el primero en escribir!</p>
                                    <small>Chat con historial persistente desarrollado por JUNIOR_ALVINES &
                                        SheralA16</small>
                                </div>
                            </div>

                            <!-- Input Container -->
                            <div class="card-footer bg-light p-3">
                                <!-- Secci√≥n de Username -->
                                <div class="row g-2 align-items-center" id="usernameSection">
                                    <div class="col-auto">
                                        <label for="usernameInput" class="form-label fw-bold text-success mb-0">
                                            <i class="bi bi-person-fill"></i> Usuario:
                                        </label>
                                    </div>
                                    <div class="col">
                                        <input type="text" class="form-control" id="usernameInput"
                                            placeholder="Tu nombre de usuario" maxlength="20">
                                        <div class="invalid-feedback" id="usernameError"></div>
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-success" id="connectBtn">
                                            <i class="bi bi-rocket-takeoff"></i> GO!
                                        </button>
                                    </div>
                                </div>

                                <!-- Secci√≥n de Mensajes -->
                                <div class="d-none" id="messageSection">
                                    <!-- Preview de imagen seleccionada -->
                                    <div class="mb-2 d-none" id="imagePreviewContainer">
                                        <div class="alert alert-info d-flex align-items-center">
                                            <img id="imagePreview" class="image-preview me-3" />
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">Imagen seleccionada</div>
                                                <div class="text-muted small" id="imageInfo"></div>
                                            </div>
                                            <button class="btn btn-outline-danger btn-sm" id="removeImageBtn">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="row g-2 align-items-center">
                                        <div class="col">
                                            <input type="text" class="form-control" id="messageInput"
                                                placeholder="Escribe tu mensaje..." maxlength="500">
                                        </div>
                                        <div class="col-auto">
                                            <div class="file-input-container">
                                                <input type="file" class="file-input-hidden" id="imageInput"
                                                    accept="image/*">
                                                <button class="btn btn-outline-success" id="imageBtn"
                                                    title="Enviar imagen">
                                                    <i class="bi bi-image"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <button class="btn btn-success" id="sendBtn" disabled>
                                                <i class="bi bi-send-fill"></i> Enviar
                                            </button>
                                        </div>
                                        <div class="col-auto">
                                            <button class="btn btn-danger" id="disconnectBtn">
                                                <i class="bi bi-power"></i> NO GO
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar de Usuarios -->
                        <div class="col-lg-4 border-start">
                            <div class="card-header chat-header text-white text-center p-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-people-fill"></i> Operadores Activos
                                </h5>
                            </div>
                            <div class="p-3">
                                <div class="users-list" id="usersList">
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-person-x fs-1"></i>
                                        <p class="small mb-0">No hay operadores conectados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="footer-brand">
                        <i class="bi bi-code-slash"></i> Desarrollado por JUNIOR_ALVINES & SheralA16 |
                        <i class="bi bi-archive"></i> Historial Persistente Habilitado
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para im√°genes -->
    <div class="modal fade image-modal" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white">Ver Imagen</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img id="modalImage" src="" alt="Imagen completa" />
                </div>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="errorToast" class="toast text-bg-danger" role="alert">
            <div class="toast-header">
                <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorToastBody">
                <!-- Mensaje de error aqu√≠ -->
            </div>
        </div>

        <div id="successToast" class="toast text-bg-success" role="alert">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong class="me-auto">¬°Conectado!</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successToastBody">
                <!-- Mensaje de √©xito aqu√≠ -->
            </div>
        </div>

        <!-- ‚≠ê NUEVO: Toast para historial -->
        <div id="historyToast" class="toast text-bg-info" role="alert">
            <div class="toast-header">
                <i class="bi bi-archive-fill text-info me-2"></i>
                <strong class="me-auto">Historial</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="historyToastBody">
                <!-- Mensaje de historial aqu√≠ -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        class ChatClient {
            constructor() {
                this.socket = null;
                this.username = '';
                this.connected = false;
                this.users = new Map();
                this.selectedImage = null;
                this.messageHistory = [];
                this.messageCounter = 0;
                this.isReceivingHistory = false; // ‚≠ê NUEVO: Flag para historial
                this.historyMessageCount = 0;   // ‚≠ê NUEVO: Contador de mensajes de historial
                this.init();
            }

            init() {
                console.log('üöÄ Inicializando GO O NO GO Chat con historial persistente...');

                this.elements = {
                    messages: document.getElementById('messages'),
                    messageInput: document.getElementById('messageInput'),
                    usernameInput: document.getElementById('usernameInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    connectBtn: document.getElementById('connectBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    connectionDetails: document.getElementById('connectionDetails'),
                    messageSection: document.getElementById('messageSection'),
                    usernameSection: document.getElementById('usernameSection'),
                    usersList: document.getElementById('usersList'),
                    onlineCount: document.getElementById('onlineCount'),
                    usernameError: document.getElementById('usernameError'),
                    errorToast: document.getElementById('errorToast'),
                    errorToastBody: document.getElementById('errorToastBody'),
                    successToast: document.getElementById('successToast'),
                    successToastBody: document.getElementById('successToastBody'),
                    historyToast: document.getElementById('historyToast'), // ‚≠ê NUEVO
                    historyToastBody: document.getElementById('historyToastBody'), // ‚≠ê NUEVO
                    imageInput: document.getElementById('imageInput'),
                    imageBtn: document.getElementById('imageBtn'),
                    imagePreview: document.getElementById('imagePreview'),
                    imagePreviewContainer: document.getElementById('imagePreviewContainer'),
                    imageInfo: document.getElementById('imageInfo'),
                    removeImageBtn: document.getElementById('removeImageBtn'),
                    imageModal: document.getElementById('imageModal'),
                    modalImage: document.getElementById('modalImage')
                };

                this.setupEventListeners();

                console.log('üíö Chat desarrollado por JUNIOR_ALVINES & SheralA16');
                console.log('üìú Historial persistente habilitado');
            }

            setupEventListeners() {
                this.elements.connectBtn.addEventListener('click', () => this.connect());
                this.elements.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());

                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });

                this.elements.usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.connect();
                });

                this.elements.messageInput.addEventListener('input', () => {
                    this.updateSendButton();
                });

                this.elements.usernameInput.addEventListener('input', () => {
                    this.clearUsernameError();
                });

                this.elements.imageBtn.addEventListener('click', () => {
                    this.elements.imageInput.click();
                });

                this.elements.imageInput.addEventListener('change', (e) => {
                    this.handleImageSelection(e);
                });

                this.elements.removeImageBtn.addEventListener('click', () => {
                    this.clearImageSelection();
                });

                this.elements.imageModal.addEventListener('hide.bs.modal', () => {
                    this.elements.modalImage.src = '';
                });
            }

            updateSendButton() {
                const hasText = this.elements.messageInput.value.trim().length > 0;
                const hasImage = this.selectedImage !== null;
                this.elements.sendBtn.disabled = !hasText && !hasImage;
            }

            handleImageSelection(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    this.showErrorToast('Por favor selecciona un archivo de imagen v√°lido');
                    return;
                }

                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    this.showErrorToast('La imagen es muy grande. M√°ximo 5MB permitido');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.selectedImage = {
                        data: e.target.result,
                        name: file.name,
                        size: file.size,
                        type: file.type
                    };

                    this.showImagePreview();
                    this.updateSendButton();
                };

                reader.onerror = () => {
                    this.showErrorToast('Error leyendo la imagen');
                };

                reader.readAsDataURL(file);
            }

            showImagePreview() {
                if (!this.selectedImage) return;

                this.elements.imagePreview.src = this.selectedImage.data;
                this.elements.imageInfo.textContent = `${this.selectedImage.name} (${this.formatFileSize(this.selectedImage.size)})`;
                this.elements.imagePreviewContainer.classList.remove('d-none');
            }

            clearImageSelection() {
                this.selectedImage = null;
                this.elements.imageInput.value = '';
                this.elements.imagePreviewContainer.classList.add('d-none');
                this.elements.imagePreview.src = '';
                this.updateSendButton();
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            connect() {
                const username = this.elements.usernameInput.value.trim();

                if (!username) {
                    this.showUsernameError('Por favor, ingresa tu nombre de usuario');
                    return;
                }

                if (username.length < 2) {
                    this.showUsernameError('El nombre debe tener al menos 2 caracteres');
                    return;
                }

                if (username.length > 20) {
                    this.showUsernameError('El nombre no puede tener m√°s de 20 caracteres');
                    return;
                }

                if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                    this.showUsernameError('Solo se permiten letras, n√∫meros, guiones y guiones bajos');
                    return;
                }

                this.username = username;
                console.log('üîå Conectando como:', username);

                this.updateStatus('connecting', 'Conectando...');
                this.updateConnectionDetails('info', 'Verificando nombre de usuario...');
                this.elements.connectBtn.disabled = true;
                this.elements.connectBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Conectando...';

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsURL = `${protocol}//${window.location.host}/ws?username=${encodeURIComponent(username)}`;

                console.log('üåê Conectando a:', wsURL);

                this.socket = new WebSocket(wsURL);

                this.socket.onopen = () => {
                    console.log('‚úÖ WebSocket abierto, esperando confirmaci√≥n...');
                };

                this.socket.onmessage = (event) => {
                    console.log('üì® Mensaje recibido:', event.data);

                    try {
                        const data = JSON.parse(event.data);

                        if (data.type === 'error') {
                            console.error('‚ùå Error del servidor:', data.message);
                            this.handleConnectionError(data.message);
                            return;
                        }

                        if (data.type === 'connectionSuccess') {
                            console.log('‚úÖ Conexi√≥n exitosa confirmada');
                            this.handleConnectionSuccess(data);
                            return;
                        }

                        // ‚≠ê NUEVOS TIPOS DE MENSAJES PARA HISTORIAL
                        if (data.type === 'historyStart') {
                            console.log('üìú Iniciando recepci√≥n de historial:', data.count, 'mensajes');
                            this.handleHistoryStart(data);
                            return;
                        }

                        if (data.type === 'historyEnd') {
                            console.log('üìú Historial completado');
                            this.handleHistoryEnd(data);
                            return;
                        }

                        if (data.type === 'userList') {
                            console.log('üë• Lista de usuarios recibida:', data.users);
                            this.updateUsersList(data.users);
                        } else {
                            console.log('üí¨ Mensaje regular recibido');
                            // ‚≠ê Determinar si es mensaje de historial o nuevo
                            const isHistoryMessage = this.isReceivingHistory;
                            this.addToLocalHistoryIfNew(data);
                            this.displayMessage(data, false, isHistoryMessage);
                        }
                    } catch (error) {
                        console.error('‚ùå Error parseando mensaje:', error);
                    }
                };

                this.socket.onclose = (event) => {
                    console.log('üîå WebSocket cerrado, c√≥digo:', event.code, 'raz√≥n:', event.reason);

                    if (!this.connected) {
                        this.handleConnectionError('No se pudo conectar al servidor');
                    } else {
                        this.connected = false;
                        this.updateStatus('disconnected', 'Desconectado');
                        this.updateConnectionDetails('warning', 'Desconectado del servidor');
                        this.toggleUI(false);
                    }
                };

                this.socket.onerror = (error) => {
                    console.error('‚ùå Error WebSocket:', error);
                    this.handleConnectionError('Error de conexi√≥n al servidor');
                };
            }

            // ‚≠ê NUEVA FUNCI√ìN: Manejar inicio de historial
            handleHistoryStart(data) {
                this.isReceivingHistory = true;
                this.historyMessageCount = data.count;

                // Mostrar notificaci√≥n de historial
                this.showHistoryNotification(`Recuperando ${data.count} mensajes perdidos`);

                // Agregar separador visual de historial
                this.addHistorySeparator('Recuperando conversaci√≥n perdida...');
            }

            // ‚≠ê NUEVA FUNCI√ìN: Manejar fin de historial
            handleHistoryEnd(data) {
                this.isReceivingHistory = false;

                // Mostrar notificaci√≥n de finalizaci√≥n
                this.showHistoryToast(`¬°Conversaci√≥n recuperada! ${this.historyMessageCount} mensajes sincronizados`);

                // Agregar separador de fin de historial
                this.addHistorySeparator('¬°Ya est√°s al d√≠a!', true);

                this.historyMessageCount = 0;
            }

            // ‚≠ê NUEVA FUNCI√ìN: Agregar separador visual de historial
            addHistorySeparator(text, isEnd = false) {
                const separatorElement = document.createElement('div');
                separatorElement.className = 'mb-3';

                const alertClass = isEnd ? 'alert-success' : 'alert-primary history-notification';
                const icon = isEnd ? 'bi-check-circle-fill' : 'bi-arrow-clockwise';

                separatorElement.innerHTML = `
                    <div class="alert ${alertClass} text-center py-2 mb-2">
                        <i class="bi ${icon}"></i> ${this.escapeHtml(text)}
                        ${!isEnd ? '<span class="loading-dots"></span>' : ''}
                    </div>
                `;

                // Limpiar mensaje de bienvenida si existe
                const welcomeMessage = this.elements.messages.querySelector('.text-muted');
                if (welcomeMessage && welcomeMessage.closest('.text-center')) {
                    this.elements.messages.innerHTML = '';
                }

                this.elements.messages.appendChild(separatorElement);
                this.scrollToBottom();
            }

            addToLocalHistoryIfNew(message) {
                if (message.type !== 'message') return;

                const messageId = this.generateMessageId(message);
                const exists = this.messageHistory.some(m =>
                    this.generateMessageId(m) === messageId
                );

                if (!exists) {
                    this.messageHistory.push(message);
                    console.log(`üìú Mensaje agregado al historial local. Total: ${this.messageHistory.length}`);
                }
            }

            generateMessageId(message) {
                const content = message.content || '';
                const imageData = message.image ? message.image.data.substring(0, 50) : '';
                const hasImage = message.hasImage ? '1' : '0';

                return `${message.username}-${message.timestamp}-${content}-${hasImage}-${imageData}`;
            }

            handleConnectionSuccess(data) {
                this.connected = true;
                this.updateStatus('connected', `Conectado como: ${data.username}`);
                this.updateConnectionDetails('success', 'Conectado al servidor');
                this.toggleUI(true);
                this.addSystemMessage(`Te has conectado al chat como "${data.username}"`);

                this.showSuccessToast(`¬°Conectado exitosamente como ${data.username}!`);

                this.elements.connectBtn.disabled = false;
                this.elements.connectBtn.innerHTML = '<i class="bi bi-rocket-takeoff"></i> GO!';
            }

            handleConnectionError(errorMessage) {
                console.error('‚ùå Error de conexi√≥n:', errorMessage);

                this.showErrorToast(errorMessage);

                this.connected = false;
                this.updateStatus('error', 'Error de conexi√≥n');
                this.updateConnectionDetails('danger', errorMessage);
                this.elements.connectBtn.disabled = false;
                this.elements.connectBtn.innerHTML = '<i class="bi bi-rocket-takeoff"></i> GO!';

                if (errorMessage.includes('ya est√° en uso')) {
                    this.showUsernameError('Este nombre ya est√° en uso. Elige otro.');
                    this.elements.usernameInput.value = '';
                    this.elements.usernameInput.focus();
                }

                if (this.socket) {
                    this.socket.close();
                    this.socket = null;
                }
            }

            disconnect() {
                if (this.socket && this.connected) {
                    this.socket.close(1000, 'Desconexi√≥n voluntaria');
                }
            }

            sendMessage() {
                if (!this.connected) return;

                const textContent = this.elements.messageInput.value.trim();

                if (!textContent && !this.selectedImage) {
                    return;
                }

                const messageData = {
                    content: textContent || '',
                    hasImage: !!this.selectedImage
                };

                if (this.selectedImage) {
                    messageData.image = {
                        data: this.selectedImage.data,
                        name: this.selectedImage.name,
                        type: this.selectedImage.type,
                        size: this.selectedImage.size
                    };
                }

                try {
                    this.socket.send(JSON.stringify(messageData));

                    this.elements.messageInput.value = '';
                    this.clearImageSelection();
                    this.updateSendButton();

                    console.log('‚úÖ Mensaje enviado:', messageData.hasImage ? 'con imagen' : 'solo texto');
                } catch (error) {
                    console.error('‚ùå Error enviando mensaje:', error);
                    this.showErrorToast('Error enviando mensaje');
                }
            }

            // ‚≠ê FUNCI√ìN MEJORADA: displayMessage con soporte para historial
            displayMessage(message, addToHistory = true, isHistoryMessage = false) {
                const isOwn = message.username === this.username;
                const isSystem = message.type === 'system' || message.type === 'join' || message.type === 'leave';

                let time;
                try {
                    time = new Date(message.timestamp).toLocaleTimeString();
                } catch (e) {
                    time = new Date().toLocaleTimeString();
                }

                const messageElement = document.createElement('div');
                messageElement.className = `mb-3 ${isOwn ? 'text-end' : ''} ${isHistoryMessage ? 'history-message' : ''}`;

                if (isSystem) {
                    messageElement.innerHTML = `
                        <div class="alert alert-info text-center py-2 mb-2">
                            <i class="bi bi-info-circle"></i> ${this.escapeHtml(message.content)}
                            <div class="message-time mt-1">${time}</div>
                        </div>
                    `;
                } else {
                    const cardClass = isOwn ? 'message-own text-white' : 'bg-light';
                    const alignment = isOwn ? 'ms-auto' : 'me-auto';

                    let messageContent = '';

                    if (message.image && message.image.data) {
                        messageContent += `
                            <div class="mb-2">
                                <img src="${message.image.data}" 
                                     class="message-image" 
                                     alt="Imagen compartida"
                                     onclick="showImageModal('${message.image.data}')"
                                     loading="lazy" />
                                <div class="small text-muted mt-1">
                                    <i class="bi bi-image"></i> ${this.escapeHtml(message.image.name)}
                                    ${isHistoryMessage ? '<span class="badge bg-secondary ms-1">Historial</span>' : ''}
                                </div>
                            </div>
                        `;
                    }

                    if (message.content && message.content.trim()) {
                        messageContent += `<div>${this.escapeHtml(message.content)}</div>`;
                    }

                    messageElement.innerHTML = `
                        <div class="card ${cardClass} ${alignment}" style="max-width: 70%;">
                            <div class="card-body py-2 px-3">
                                ${!isOwn ? `<div class="fw-bold small mb-1">
                                    ${this.escapeHtml(message.username)}
                                    ${isHistoryMessage ? '<span class="badge bg-secondary ms-1">Historial</span>' : ''}
                                </div>` : ''}
                                ${messageContent}
                                <div class="message-time mt-1">${time}</div>
                            </div>
                        </div>
                    `;
                }

                // Limpiar mensaje de bienvenida si existe
                const welcomeMessage = this.elements.messages.querySelector('.text-muted');
                if (welcomeMessage && welcomeMessage.closest('.text-center')) {
                    this.elements.messages.innerHTML = '';
                }

                this.elements.messages.appendChild(messageElement);
                this.scrollToBottom();
            }

            updateUsersList(users) {
                this.elements.usersList.innerHTML = '';

                if (!users || users.length === 0) {
                    this.elements.usersList.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-person-x fs-1"></i>
                            <p class="small mb-0">No hay operadores conectados</p>
                        </div>
                    `;
                    this.updateOnlineCount(0);
                    return;
                }

                const connectedUsers = users.filter(user => user.connected);
                const disconnectedUsers = users.filter(user => !user.connected);

                connectedUsers.forEach(user => this.addUserToList(user));
                disconnectedUsers.forEach(user => this.addUserToList(user));

                this.updateOnlineCount(connectedUsers.length);
            }

            addUserToList(user) {
                const statusClass = user.connected ? 'online' : 'offline';
                const statusIcon = user.connected ? 'bi-circle-fill text-success' : 'bi-circle text-muted';

                let timeText;
                try {
                    if (user.connected) {
                        timeText = `Conectado ${this.formatRelativeTime(new Date(user.connectedAt))}`;
                    } else {
                        timeText = `√ölt. vez ${this.formatRelativeTime(new Date(user.lastSeen))}`;
                    }
                } catch (e) {
                    timeText = user.connected ? 'Conectado ahora' : 'Desconectado';
                }

                const userElement = document.createElement('div');
                userElement.className = 'card mb-2';
                userElement.innerHTML = `
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center">
                            <div class="user-status ${statusClass} me-2"></div>
                            <div class="flex-grow-1">
                                <div class="fw-bold small">${this.escapeHtml(user.username)}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">${timeText}</div>
                            </div>
                            <i class="bi ${statusIcon}"></i>
                        </div>
                    </div>
                `;

                this.elements.usersList.appendChild(userElement);
            }

            formatRelativeTime(date) {
                try {
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);

                    if (diffMins < 1) return 'ahora';
                    if (diffMins < 60) return `hace ${diffMins}m`;
                    if (diffHours < 24) return `hace ${diffHours}h`;

                    return date.toLocaleDateString();
                } catch (e) {
                    return 'ahora';
                }
            }

            updateOnlineCount(count) {
                this.elements.onlineCount.innerHTML = `
                    <i class="bi bi-people-fill"></i> ${count} conectado${count !== 1 ? 's' : ''}
                `;
            }

            addSystemMessage(content) {
                const systemMessage = {
                    username: 'Sistema',
                    content: content,
                    timestamp: new Date().toISOString(),
                    type: 'system'
                };
                this.displayMessage(systemMessage, false);
            }

            updateStatus(statusType, text) {
                const icons = {
                    connected: 'bi-circle-fill text-success',
                    connecting: 'bi-hourglass-split text-warning',
                    disconnected: 'bi-circle-fill text-danger',
                    error: 'bi-exclamation-triangle-fill text-danger'
                };

                this.elements.connectionStatus.innerHTML = `
                    <i class="${icons[statusType] || 'bi-circle-fill text-secondary'}"></i> ${text}
                `;
            }

            updateConnectionDetails(alertType, text) {
                this.elements.connectionDetails.className = `alert alert-${alertType} mb-0 text-center border-0`;
                this.elements.connectionDetails.innerHTML = `
                    <i class="bi bi-info-circle"></i> ${text}
                `;
            }

            toggleUI(connected) {
                if (connected) {
                    this.elements.usernameSection.classList.add('d-none');
                    this.elements.messageSection.classList.remove('d-none');
                    this.elements.messageInput.focus();
                } else {
                    this.elements.usernameSection.classList.remove('d-none');
                    this.elements.messageSection.classList.add('d-none');
                    this.elements.usernameInput.focus();

                    this.elements.usersList.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-person-x fs-1"></i>
                            <p class="small mb-0">No hay operadores conectados</p>
                        </div>
                    `;
                    this.updateOnlineCount(0);
                }
                this.updateSendButton();
            }

            showUsernameError(message) {
                this.elements.usernameInput.classList.add('is-invalid');
                this.elements.usernameError.textContent = message;
            }

            clearUsernameError() {
                this.elements.usernameInput.classList.remove('is-invalid');
                this.elements.usernameError.textContent = '';
            }

            showErrorToast(message) {
                this.elements.errorToastBody.textContent = message;
                const toast = new bootstrap.Toast(this.elements.errorToast);
                toast.show();
            }

            showSuccessToast(message) {
                this.elements.successToastBody.textContent = message;
                const toast = new bootstrap.Toast(this.elements.successToast);
                toast.show();
            }

            // ‚≠ê NUEVA FUNCI√ìN: Mostrar toast de historial
            showHistoryToast(message) {
                this.elements.historyToastBody.textContent = message;
                const toast = new bootstrap.Toast(this.elements.historyToast);
                toast.show();
            }

            // ‚≠ê NUEVA FUNCI√ìN: Mostrar notificaci√≥n de historial
            showHistoryNotification(message) {
                this.updateConnectionDetails('info', message);
            }

            scrollToBottom() {
                this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Funci√≥n global para el modal
        window.showImageModal = function (imageSrc) {
            try {
                const modalImage = document.getElementById('modalImage');
                const imageModal = document.getElementById('imageModal');

                modalImage.src = imageSrc;
                const modal = new bootstrap.Modal(imageModal);
                modal.show();
                console.log('üñºÔ∏è Modal de imagen abierto');
            } catch (error) {
                console.error('‚ùå Error abriendo modal:', error);
            }
        };

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üé¨ DOM cargado, iniciando GO O NO GO Chat...');
            console.log('üë®‚Äçüíª Desarrollado por JUNIOR_ALVINES & SheralA16');
            console.log('üìú Historial persistente habilitado');
            window.chatClient = new ChatClient();
        });
    </script>
</body>

</html>